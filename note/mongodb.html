<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<link rel="stylesheet" href="/static/style.css" />
<title>MongoDB - Seorenn</title>
<meta name="twitter:title" content="MongoDB" />
<meta name="og:title" content="MongoDB" />
<meta name="description" content="몽고디비(MongoDB)의 간단한 소개와 사용법 정리" />
<meta name="twitter:description" content="몽고디비(MongoDB)의 간단한 소개와 사용법 정리" />
<meta name="og:description" content="몽고디비(MongoDB)의 간단한 소개와 사용법 정리" />
<link rel="canonical" href="https://seorenn.github.io/note/mongodb.html" />
<meta property="og:url" content="https://seorenn.github.io/note/mongodb.html" />
<link rel="alternate" type="application/rss+xml" title="Seorenn Note Feeds" href="/rss.xml"/>
<link rel="shortcut icon" type="image/x-icon" href="/static/favicon.ico" />
<meta name="twitter:image"content="https://seorenn.github.io/static/seorenn-symbol.png" />
<meta property="og:image" content="https://seorenn.github.io/static/seorenn-symbol.png" />
<meta property="og:image:width" content="520" />
<meta property="og:image:height" content="329" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:site" content="@seorenn" />
<meta name="twitter:creator" content="@seorenn" />
<meta property="og:type" content="article" />
<meta property="og:site_name" content="Seorenn Note" />
<meta property="og:locale" content="ko_KR" />
<meta name="referrer" content="unsafe-url" />
<meta name="robots" content="follow,index" />
<meta name="google-site-verification" content="YqTFZuthbvGIlDE1dhxiTjZ3m-GfyNs_rsHaOlPKpug" />
<meta name="naver-site-verification" content="ebf6a89968fd9f447c1a77d83e2c4aa9bdbb0345" />
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-44534026-1"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-44534026-1');
</script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</head>
<body>
<header class="top-header">
<div class="logo-container">
<a href="/" title="Seorenn"><img class="site-logo" src="/static/seorenn-logo.png" /></a>
<nav>
<a href="/" title="Home"><img src="/static/icon-home.svg" alt="home" class="menu-icon" /></a>
<a href="/post" title="Post"><img src="/static/icon-post.svg" alt="post" class="menu-icon" /></a>
 <a href="/note" title="Note"><img src="/static/icon-note.svg" alt="note" class="menu-icon" /></a>
</nav>
</div>
</header>
<div class="top-ad-container">
<ins class="adsbygoogle top-ad"
     style="display:block"
     data-ad-client="ca-pub-1071465863344332"
     data-ad-slot="4306465772"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<hr/>
<div class="content-container">
<div class="left-empty">
</div>
<section class="content">
<header>
<h1>MongoDB</h1>
<div class="title-date">2020년 4월 18일 수정</div>
</header>
<div id="table-of-contents">
<h2>≡ 목차 (Table of Contents)</h2><div id="text-table-of-contents">
<ul>
<li><a href="#orgc1a137d">CLI 사용법 메모</a>
<ul>
<li><a href="#org579ad5e">연결하기(Connect)</a></li>
<li><a href="#org2550676">데이터베이스 선택(Select Database)</a></li>
<li><a href="#org8a2545e">데이터베이스 목록 보기(List Databases)</a></li>
<li><a href="#orgf1f3531">컬렉션 조회(List Collections)</a></li>
<li><a href="#orgcd05b70">삽입(Insert)</a></li>
<li><a href="#org82bd242">조회(Find or Query)</a></li>
<li><a href="#orgf997d1a">수정(Update)</a></li>
<li><a href="#org82093c0">삭제(Remove)</a></li>
</ul>
</li>
<li><a href="#org88805a8">조회법 메모</a>
<ul>
<li><a href="#orgae6097c">정렬, 위치, 갯수 제한</a></li>
<li><a href="#orga0042d2">수치 비교</a></li>
<li><a href="#orgc47bdc6">특정 필드 표시하지 않기</a></li>
<li><a href="#orgda73119">특정 필드가 있는 도큐먼트 검색하기</a></li>
<li><a href="#orgfd26f42">Not Null???</a></li>
</ul>
</li>
<li><a href="#org2dcb043">어그리게이트(Aggregate)</a>
<ul>
<li><a href="#org0a6c2c4">기초</a></li>
<li><a href="#orgfd106af">예제</a></li>
<li><a href="#org64d1953">몇 가지 유용한 파이프라인 오퍼레이터</a></li>
</ul>
</li>
<li><a href="#org91bcc37">백업 및 복원(Dump and Restore)</a>
<ul>
<li><a href="#org02121f0">백업(Dump)</a></li>
<li><a href="#orgf4d62a0">복원(Restore)</a></li>
</ul>
</li>
<li><a href="#orgfb1151b">기타</a>
<ul>
<li><a href="#org4551166">컬렉션 몽땅 비우기(지우기)</a></li>
<li><a href="#org3391875">Replica Set 에서 Primary 바꾸기</a></li>
</ul>
</li>
</ul>
</div>
</div>
<p>
MongoDB 는 이름처럼 Database 시스템이다.
가장 큰 특징은 도큐먼트 기반 데이터베이스,
즉 고정된 스키마가 없는 동적인 데이터를 관리하는 데이터베이스다.
이로 인해 NoSQL DB 의 대명사이기도 하다.
</p>

<div id="outline-container-orgc1a137d" class="outline-2">
<h2 id="orgc1a137d"><a href="cli.html">CLI</a> 사용법 메모</h2>
<div class="outline-text-2" id="text-orgc1a137d">
</div>
<div id="outline-container-org579ad5e" class="outline-3">
<h3 id="org579ad5e">연결하기(Connect)</h3>
<div class="outline-text-3" id="text-org579ad5e">
<div class="org-src-container">
<pre class="src src-bash">mongo --host foo.bar --port <span style="color: #da8548; font-weight: bold;">27017</span>
</pre>
</div>
<p>
참고로 27017은 MongoDB 의 기본 포트다. 따라서 이 경우 생략해도 된다.
</p>

<p>
URI를 이용한 접속도 가능하다.
</p>
<div class="org-src-container">
<pre class="src src-bash">mongo mongodb://host.foo.bar:27017/dbname
</pre>
</div>
<p>
dbname 은 생략할 수 있다.
</p>
</div>
</div>
<div id="outline-container-org2550676" class="outline-3">
<h3 id="org2550676">데이터베이스 선택(Select Database)</h3>
<div class="outline-text-3" id="text-org2550676">
<div class="org-src-container">
<pre class="src src-javascript">use dbname
</pre>
</div>
</div>
</div>
<div id="outline-container-org8a2545e" class="outline-3">
<h3 id="org8a2545e">데이터베이스 목록 보기(List Databases)</h3>
<div class="outline-text-3" id="text-org8a2545e">
<div class="org-src-container">
<pre class="src src-javascript">db.adminCommand({listDatabases: <span style="color: #da8548; font-weight: bold;">1</span>})
</pre>
</div>
<p>
왜 이런 중요한 커맨드를 따로 만들어 두지 않았는지 의문이다.
기억 안 나면 어떻게 찾으라는 건지 모르겠다.
</p>
</div>
</div>
<div id="outline-container-orgf1f3531" class="outline-3">
<h3 id="orgf1f3531">컬렉션 조회(List Collections)</h3>
<div class="outline-text-3" id="text-orgf1f3531">
<div class="org-src-container">
<pre class="src src-javascript">show collections
</pre>
</div>
</div>
</div>
<div id="outline-container-orgcd05b70" class="outline-3">
<h3 id="orgcd05b70">삽입(Insert)</h3>
<div class="outline-text-3" id="text-orgcd05b70">
<div class="org-src-container">
<pre class="src src-javascript">db.collection.insert({key: value, ...})
</pre>
</div>
</div>
</div>
<div id="outline-container-org82bd242" class="outline-3">
<h3 id="org82bd242">조회(Find or Query)</h3>
<div class="outline-text-3" id="text-org82bd242">
<div class="org-src-container">
<pre class="src src-javascript">db.colllection.find({key: value, ...})
</pre>
</div>
<p>
좀 더 고급 검색 쿼리는 아래에 따로 메모한다.
</p>
</div>
</div>
<div id="outline-container-orgf997d1a" class="outline-3">
<h3 id="orgf997d1a">수정(Update)</h3>
<div class="outline-text-3" id="text-orgf997d1a">
<div class="org-src-container">
<pre class="src src-javascript">db.collection.update({key: value, ...}, {$set: {key: value, ...}})
</pre>
</div>
<p>
첫 매개변수는 어떤 도큐먼트인지 검색하기 위한 조건으로
find 에서 쓰는 쿼리와 동일하다.
</p>

<p>
두 번째 매개변수는 업데이트 하려는 내용을 적는 곳이다.
위 예제는 특정 필드의 값을 업데이트(set) 하려는 경우이고,
도큐먼트를 통째로 갈아 엎으려면
그냥 두 번째 매개변수에 도큐먼트를 그냥 넣어버리면 된다.
</p>
</div>
</div>
<div id="outline-container-org82093c0" class="outline-3">
<h3 id="org82093c0">삭제(Remove)</h3>
<div class="outline-text-3" id="text-org82093c0">
<div class="org-src-container">
<pre class="src src-javascript">db.collection.remove({key: value, ...})
</pre>
</div>
<p>
당연히 find 에서 쓰던 쿼리를 그대로 쓸 수 있다.
</p>
</div>
</div>
</div>
<div id="outline-container-org88805a8" class="outline-2">
<h2 id="org88805a8">조회법 메모</h2>
<div class="outline-text-2" id="text-org88805a8">
</div>
<div id="outline-container-orgae6097c" class="outline-3">
<h3 id="orgae6097c">정렬, 위치, 갯수 제한</h3>
<div class="outline-text-3" id="text-orgae6097c">
<div class="org-src-container">
<pre class="src src-javascript">db.collection.find({key: value, ...})
             .sort({field: -<span style="color: #da8548; font-weight: bold;">1</span>})
             .skip(<span style="color: #da8548; font-weight: bold;">5</span>)
             .limit(<span style="color: #da8548; font-weight: bold;">10</span>)
</pre>
</div>
<p>
정렬 시 -1 값은 역순(Descending) 정렬을 의미한다. 반대로 1은 순차(Ascending)로 정렬한다.
</p>
</div>
</div>
<div id="outline-container-orga0042d2" class="outline-3">
<h3 id="orga0042d2">수치 비교</h3>
<div class="outline-text-3" id="text-orga0042d2">
<div class="org-src-container">
<pre class="src src-javascript">db.collection.find({key: {$gt: <span style="color: #da8548; font-weight: bold;">10</span>}})
</pre>
</div>
<dl class="org-dl">
<dt><code>gt</code></dt><dd>왼쪽이 오른쪽보다 큼(Greater Than)</dd>
<dt><code>lt</code></dt><dd>왼쪽이 오른쪽보다 작음(Less Than)</dd>
<dt><code>gte</code></dt><dd>왼쪽이 오른쪽 보다 크거나 같음(Greater Than or Equal)</dd>
<dt><code>lte</code></dt><dd>왼쪽이 오른쪽 보다 작거나 같음 (Less Than or Equal)</dd>
</dl>
</div>
</div>
<div id="outline-container-orgc47bdc6" class="outline-3">
<h3 id="orgc47bdc6">특정 필드 표시하지 않기</h3>
<div class="outline-text-3" id="text-orgc47bdc6">
<div class="org-src-container">
<pre class="src src-javascript">db.collection.find({key: value, ...},
                   {keyToHide: <span style="color: #da8548; font-weight: bold;">0</span>})
</pre>
</div>
<p>
find()의 두 번째 필드는 여러 옵션을 줄 수 있는데
이렇게 특정 필드를 결과에서 생략할 수도 있다.
</p>
</div>
</div>
<div id="outline-container-orgda73119" class="outline-3">
<h3 id="orgda73119">특정 필드가 있는 도큐먼트 검색하기</h3>
<div class="outline-text-3" id="text-orgda73119">
<div class="org-src-container">
<pre class="src src-javascript">db.collection.find({key: {$exists: <span style="color: #a9a1e1;">true</span>}})
</pre>
</div>
<p>
물론 <code>false</code> 로 특정 필드가 없는 도큐먼트를 조회하는 것도 가능하다.
</p>
</div>
</div>
<div id="outline-container-orgfd26f42" class="outline-3">
<h3 id="orgfd26f42">Not Null???</h3>
<div class="outline-text-3" id="text-orgfd26f42">
<div class="org-src-container">
<pre class="src src-javascript">db.collection.find({key: {$ne: <span style="color: #a9a1e1;">null</span>}})
</pre>
</div>
<p>
참고로 <code>ne</code> 는 Not Equal 의 약자다.
</p>
</div>
</div>
</div>
<div id="outline-container-org2dcb043" class="outline-2">
<h2 id="org2dcb043">어그리게이트(Aggregate)</h2>
<div class="outline-text-2" id="text-org2dcb043">
<p>
어그리게이트는 도큐먼트를 파이프 라인을 통해
여러 차례에 걸쳐서 처리할 수 있도록 하는 특수한 기능이다.
마치 UNIX 유틸리티를 파이프로 묶어서 결과물을 처리하고
이걸 결과로 넘기는 식이 일렬로 처리되는 것과 비슷하다.
</p>
</div>
<div id="outline-container-org0a6c2c4" class="outline-3">
<h3 id="org0a6c2c4">기초</h3>
<div class="outline-text-3" id="text-org0a6c2c4">
<p>
어그리게이트의 기본 문법은 아래와 같다.
</p>
<div class="org-src-container">
<pre class="src src-text">db.collection.aggregate([{SYNTAX}, ...])
</pre>
</div>
<p>
<code>aggregate</code> 의 매개변수가 리스트라는 점에 주의하자.
리스트 안에 나열되는 식들은 각각 함수나 유틸리티 형태이고,
이 리스트의 순서대로 데이터가 흐르며 처리된다.
</p>
</div>
</div>
<div id="outline-container-orgfd106af" class="outline-3">
<h3 id="orgfd106af">예제</h3>
<div class="outline-text-3" id="text-orgfd106af">
<div class="org-src-container">
<pre class="src src-text">db.user.aggregate([
    {$match:
        {created: {$gte: ISODate("2000-01-01T00:00:00")}}
    },
    {$group:
        {_id: '$address',
         count: {$sum: 1}
        },
    },
])
</pre>
</div>
<p>
두 개의 기능을 이용한 어그리게이트 예제로,
user라는 컬렉션에서 2000년 이후로 가입한 사람들만 간추려서
주소가 같은 사용자의 갯수를 센다고 가정한 예제다.
</p>

<p>
여기서 제일 처음의 <code>$match</code> 는 <code>find</code> 와 비슷하게
컬렉션에서 도큐먼트를 걸러(filter) 내서 다음으로 넘깁니다.
</p>

<p>
그 다음의 <code>$group</code> 은 앞서 필터링 된 도큐먼트를 받아서
<code>address</code> 라는 필터를 기준으로 도큐먼트의 합을 계산한다.
<code>$sum</code> 함수는 데이터의 합계를 구하는 함수인데
이 예제에서는 갯수를 세기 위함이므로 1이라는 숫자로 합한다.
</p>
</div>
</div>
<div id="outline-container-org64d1953" class="outline-3">
<h3 id="org64d1953">몇 가지 유용한 파이프라인 오퍼레이터</h3>
<div class="outline-text-3" id="text-org64d1953">
<ul class="org-ul">
<li><code>$match</code> 필터 혹은 쿼리(find와 비슷)</li>
<li><code>$group</code> 특정한 필드를 기준으로 모으기(grouping)</li>
<li><code>$project</code> 도큐먼트의 모양을 바꿈</li>
<li><code>$lookup</code> 다른 컬렉션의 필드 가져오기(join과 비슷)</li>
<li><code>$sort</code> 정렬</li>
<li><code>$limit</code> 갯수 제한</li>
<li><code>$count</code> 도큐먼트 갯수</li>
</ul>

<p>
사실상 <code>$match</code> 와 <code>$group</code> 이 가장 많이 쓰이므로
이 둘을 잘 알아두면 유용하게 쓸 수 있다.
</p>

<p>
더 알고 싶다면
<a target="_blank" href="https://docs.mongodb.com/manual/reference/operator/aggregation-pipeline/">🌏Aggregation
Pipeline Stages</a> 문서를 참고해보자.
</p>
</div>
</div>
</div>
<div id="outline-container-org91bcc37" class="outline-2">
<h2 id="org91bcc37">백업 및 복원(Dump and Restore)</h2>
<div class="outline-text-2" id="text-org91bcc37">
</div>
<div id="outline-container-org02121f0" class="outline-3">
<h3 id="org02121f0">백업(Dump)</h3>
<div class="outline-text-3" id="text-org02121f0">
<div class="org-src-container">
<pre class="src src-bash">mongodump --host host.foo.bar <span style="color: #98be65;">\</span>
          --out /foo/bar/dump/directory <span style="color: #98be65;">\</span>
          --db dbName <span style="color: #98be65;">\</span>
          -c collectionName <span style="color: #98be65;">\</span>
          -q <span style="color: #98be65;">'{key: value}'</span>
</pre>
</div>
<p>
그냥 자주 쓸 만한 옵션을 다 붙여서 나열한 것이고
이 중에 필요한 것만 골라서 사용하면 된다.
</p>
</div>
</div>
<div id="outline-container-orgf4d62a0" class="outline-3">
<h3 id="orgf4d62a0">복원(Restore)</h3>
<div class="outline-text-3" id="text-orgf4d62a0">
<div class="org-src-container">
<pre class="src src-bash">mongorestore --host host.foo.bar /foo/bar/dump/directory
</pre>
</div>
<p>
백업(dump)할 때 데이터베이스 관련 정보도 백업 되므로
복원할 때는 다른 옵션이 필요하지 않다.
</p>
</div>
</div>
</div>
<div id="outline-container-orgfb1151b" class="outline-2">
<h2 id="orgfb1151b">기타</h2>
<div class="outline-text-2" id="text-orgfb1151b">
</div>
<div id="outline-container-org4551166" class="outline-3">
<h3 id="org4551166">컬렉션 몽땅 비우기(지우기)</h3>
<div class="outline-text-3" id="text-org4551166">
<div class="org-src-container">
<pre class="src src-javascript">db.collection.remove({})
</pre>
</div>
<p>
무서운 커맨드다. 조심하자.
</p>
</div>
</div>
<div id="outline-container-org3391875" class="outline-3">
<h3 id="org3391875">Replica Set 에서 Primary 바꾸기</h3>
<div class="outline-text-3" id="text-org3391875">
<p>
삽질로 알아낸 정보라 이 방법 외에 다른 방법이 있을 수도 있음을 먼저 알린다.
</p>

<p>
우선 mongo <a href="cli.html">CLI</a> 도구로 접속해서 설정을 얻어보자.
</p>
<div class="org-src-container">
<pre class="src src-text">&gt; cfg = rs.conf()
</pre>
</div>
<p>
여기서 members 의 내용에서 ip 주소를 이용해 무엇이 primary인지 파악해보자.
파악이 되면 primary가 아닌 것들의 priority를 낮춰야 한다.
</p>
<div class="org-src-container">
<pre class="src src-text">&gt; cfg.members[1].priority = 0.5
</pre>
</div>
<p>
1은 그냥 예제일 뿐이고 정확한 인덱스를 입력해야 한다.
0.5라는 수치도 그냥 예제이며 그냥 primary의 priority 보다 작기만 하면 된다.
</p>

<p>
수치를 다 바꿨으면 설정을 업데이트 해야 한다.
</p>
<div class="org-src-container">
<pre class="src src-text">&gt; rs.reconfig(cfg)
</pre>
</div>
<p>
이러면 해결이 되면 좋은데 가끔 다시 바뀌는 경우도 있어서 참 곤란한 녀석이다.
</p>
</div>
</div>
</div>
<div class="mid-ad-container">
<ins class="adsbygoogle mid-ad"
     style="display:block"
     data-ad-client="ca-pub-1071465863344332"
     data-ad-slot="4306465772"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
</section>
<div class="side-ad-container">
<ins class="adsbygoogle side-ad"
     style="display:block"
     data-ad-client="ca-pub-1071465863344332"
     data-ad-slot="4306465772"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
</div>
<hr/>
<footer>
Copyright 2019 ~ 2020. Seorenn all rights reserved.
</footer>
</body>
</html>
