<!DOCTYPE html>
<html lang="kr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>MongoDB - Seorenn Static Pages</title>
<meta name="generator" content="Org mode">
<meta name="author" content="Heeseung Seo (Seorenn)">
<meta name="description" content="몽고디비(MongoDB)의 간단한 소개와 사용법 정리">
<meta name="keywords" content="mongodb, mongo, query, find, usage, aggregate, 몽고, 디비, 데이터베이스, 쿼리, 검색, 질의, 사용법, 삭제, 수정, 업데이트, 그룹, 어그리게이트, 백업, 복원">
<meta property="og:title" content="MongoDB" />
<meta property="og:description" content="몽고디비(MongoDB)의 간단한 소개와 사용법 정리" />
<meta property="og:type" content="website" />
<meta property="og:image" content="https://seorenn.github.io/img/seorenn-logo.png" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="MongoDB" />
<meta name="twitter:description" content="몽고디비(MongoDB)의 간단한 소개와 사용법 정리" />
<meta name="twitter:image" content="https://seorenn.github.io/img/seorenn-logo.png" />
<meta name="twitter:site" content="@seorenn" />
<meta name="twitter:creator" content="@seorenn" />
<link rel="stylesheet" type="text/css" href="/static/style.css"/>
<link rel="shortcut icon" type="image/x-icon" href="favicon.ico"/>
<link rel="canonical" href="https://seorenn.github.io/mongodb.html"/>
<link property="og:url" href="https://seorenn.github.io/mongodb.html"/>
<meta name="google-site-verification" content="YqTFZuthbvGIlDE1dhxiTjZ3m-GfyNs_rsHaOlPKpug" />
<meta name="naver-site-verification" content="ebf6a89968fd9f447c1a77d83e2c4aa9bdbb0345"/>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-44534026-1"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-44534026-1');
</script>
</head>
<body>
<div id="content">
<header>
<h1 class="title">MongoDB</h1>
<h2><a href="/">Seorenn Static Pages</a></h2></header><nav id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org2039e70">소개</a></li>
<li><a href="#orgda44b49">CLI 사용법 메모</a>
<ul>
<li><a href="#orgb395513">연결하기(Connect)</a></li>
<li><a href="#orgba84b07">데이터베이스 선택(Select Database)</a></li>
<li><a href="#org45e842b">컬렉션 조회(List Collections)</a></li>
<li><a href="#org4231708">삽입(Insert)</a></li>
<li><a href="#orgbd38c48">조회(Find or Query)</a></li>
<li><a href="#org39e7d11">수정(Update)</a></li>
<li><a href="#org4caf94f">삭제(Remove)</a></li>
</ul>
</li>
<li><a href="#orgb9d5393">조회법 메모</a>
<ul>
<li><a href="#org9037775">정렬, 위치, 갯수 제한</a></li>
<li><a href="#org45ce76a">수치 비교</a></li>
<li><a href="#org00eb377">특정 필드 표시하지 않기</a></li>
<li><a href="#org28b73d1">특정 필드가 있는 도큐먼트 검색하기</a></li>
<li><a href="#org816f4ec">Not Null???</a></li>
</ul>
</li>
<li><a href="#orgdcf5ff2">어그리게이트(Aggregate)</a>
<ul>
<li><a href="#orgcb88c10">기초</a></li>
<li><a href="#orgc93d477">예제</a></li>
<li><a href="#orgb25d71d">몇 가지 유용한 파이프라인 오퍼레이터</a></li>
</ul>
</li>
<li><a href="#org39be9d2">백업 및 복원(Dump and Restore)</a>
<ul>
<li><a href="#orgfee39d5">Dump</a></li>
<li><a href="#org50d0515">Restore</a></li>
</ul>
</li>
<li><a href="#org5a62270">기타</a>
<ul>
<li><a href="#org85254f2">컬렉션 몽땅 비우기(지우기)</a></li>
<li><a href="#orgbe117f4">Replica Set 에서 Primary 바꾸기</a></li>
</ul>
</li>
</ul>
</div>
</nav>

<div id="outline-container-org2039e70" class="outline-2">
<h2 id="org2039e70">소개</h2>
<div class="outline-text-2" id="text-org2039e70">
<p>
MongoDB 는 이름처럼 Database 시스템입니다. 가장 큰 특징은 도큐먼트 기반
데이터베이스, 즉 고정된 스키마가 없는 동적인 데이터를 관리하는
데이터베이스입니다.
이로 인해 NoSQL DB 의 대명사가 되기도 했습니다.
</p>
</div>
</div>
<div id="outline-container-orgda44b49" class="outline-2">
<h2 id="orgda44b49">CLI 사용법 메모</h2>
<div class="outline-text-2" id="text-orgda44b49">
</div>
<div id="outline-container-orgb395513" class="outline-3">
<h3 id="orgb395513">연결하기(Connect)</h3>
<div class="outline-text-3" id="text-orgb395513">
<div class="org-src-container">
<pre class="src src-bash">mongo --host foo.bar --port <span style="color: #da8548; font-weight: bold;">27017</span>
</pre>
</div>
<p>
참고로 27017은 MongoDB 의 Default Port 입니다. 따라서 이 경우 생략해도 됩니다.
</p>

<p>
이 외에 URI를 이용한 접속도 가능합니다.
</p>
<div class="org-src-container">
<pre class="src src-bash">mongo mongodb://host.foo.bar:27017/dbname
</pre>
</div>
<p>
dbname 은 생략할 수 있습니다.
</p>
</div>
</div>
<div id="outline-container-orgba84b07" class="outline-3">
<h3 id="orgba84b07">데이터베이스 선택(Select Database)</h3>
<div class="outline-text-3" id="text-orgba84b07">
<div class="org-src-container">
<pre class="src src-javascript">use dbname
</pre>
</div>
</div>
</div>
<div id="outline-container-org45e842b" class="outline-3">
<h3 id="org45e842b">컬렉션 조회(List Collections)</h3>
<div class="outline-text-3" id="text-org45e842b">
<div class="org-src-container">
<pre class="src src-javascript">show collections
</pre>
</div>
</div>
</div>
<div id="outline-container-org4231708" class="outline-3">
<h3 id="org4231708">삽입(Insert)</h3>
<div class="outline-text-3" id="text-org4231708">
<div class="org-src-container">
<pre class="src src-javascript">db.collection.insert({key: value, ...})
</pre>
</div>
</div>
</div>
<div id="outline-container-orgbd38c48" class="outline-3">
<h3 id="orgbd38c48">조회(Find or Query)</h3>
<div class="outline-text-3" id="text-orgbd38c48">
<div class="org-src-container">
<pre class="src src-javascript">db.colllection.find({key: value, ...})
</pre>
</div>
<p>
좀 더 고급 검색 쿼리는 아래에 따로 메모합니다.
</p>
</div>
</div>
<div id="outline-container-org39e7d11" class="outline-3">
<h3 id="org39e7d11">수정(Update)</h3>
<div class="outline-text-3" id="text-org39e7d11">
<div class="org-src-container">
<pre class="src src-javascript">db.collection.update({key: value, ...}, {$set: {key: value, ...}})
</pre>
</div>
<p>
첫 매개변수는 어떤 도큐먼트인지 검색하기 위한 조건으로 find 에서 쓰는 쿼리와
동일합니다.
</p>

<p>
두 번째 매개변수는 업데이트 하려는 내용을 적는 곳입니다.
위 예제는 특정 필드의 값을 업데이트(set) 하려는 경우이고,
도큐먼트를 통째로 갈아 엎으려면 그냥 두 번째 매개변수에 도큐먼드를 그냥 넣어버리면 됩니다.
</p>
</div>
</div>
<div id="outline-container-org4caf94f" class="outline-3">
<h3 id="org4caf94f">삭제(Remove)</h3>
<div class="outline-text-3" id="text-org4caf94f">
<div class="org-src-container">
<pre class="src src-javascript">db.collection.remove({key: value, ...})
</pre>
</div>
<p>
당연히 find 에서 쓰던 쿼리를 그대로 쓸 수 있습니다.
</p>
</div>
</div>
</div>
<div id="outline-container-orgb9d5393" class="outline-2">
<h2 id="orgb9d5393">조회법 메모</h2>
<div class="outline-text-2" id="text-orgb9d5393">
</div>
<div id="outline-container-org9037775" class="outline-3">
<h3 id="org9037775">정렬, 위치, 갯수 제한</h3>
<div class="outline-text-3" id="text-org9037775">
<div class="org-src-container">
<pre class="src src-javascript">db.collection.find({key: value, ...})
             .sort({field: -<span style="color: #da8548; font-weight: bold;">1</span>})
             .skip(<span style="color: #da8548; font-weight: bold;">5</span>)
             .limit(<span style="color: #da8548; font-weight: bold;">10</span>)
</pre>
</div>
<p>
정렬 시 -1 값은 역순(Descending) 정렬을 의미합니다. 반대로 1은 순차(Ascending)로 정렬합니다.
</p>
</div>
</div>
<div id="outline-container-org45ce76a" class="outline-3">
<h3 id="org45ce76a">수치 비교</h3>
<div class="outline-text-3" id="text-org45ce76a">
<div class="org-src-container">
<pre class="src src-javascript">db.collection.find({key: {$gt: <span style="color: #da8548; font-weight: bold;">10</span>}})
</pre>
</div>
<p>
<code>gt</code> (Greater Than), <code>lt</code> (Less Than), <code>gte</code> (Greater Than or Equal), <code>lte</code>
(Less Than or Equal)
</p>
</div>
</div>
<div id="outline-container-org00eb377" class="outline-3">
<h3 id="org00eb377">특정 필드 표시하지 않기</h3>
<div class="outline-text-3" id="text-org00eb377">
<div class="org-src-container">
<pre class="src src-javascript">db.collection.find({key: value, ...},
                   {keyToHide: <span style="color: #da8548; font-weight: bold;">0</span>})
</pre>
</div>
<p>
find()의 두 번째 필드는 여러 옵션을 줄 수 있는데 이렇게 특정 필드를 필터링 할 수도 있습니다.
</p>
</div>
</div>
<div id="outline-container-org28b73d1" class="outline-3">
<h3 id="org28b73d1">특정 필드가 있는 도큐먼트 검색하기</h3>
<div class="outline-text-3" id="text-org28b73d1">
<div class="org-src-container">
<pre class="src src-javascript">db.collection.find({key: {$exists: <span style="color: #a9a1e1;">true</span>}})
</pre>
</div>
<p>
물론 <code>false</code> 로 특정 필드가 없는 도큐먼트를 조회하는 것도 가능합니다.
</p>
</div>
</div>
<div id="outline-container-org816f4ec" class="outline-3">
<h3 id="org816f4ec">Not Null???</h3>
<div class="outline-text-3" id="text-org816f4ec">
<div class="org-src-container">
<pre class="src src-javascript">db.collection.find({key: {$ne: <span style="color: #a9a1e1;">null</span>}})
</pre>
</div>
<p>
참고로 <code>ne</code> 는 Not Equal 의 약자입니다.
</p>
</div>
</div>
</div>
<div id="outline-container-orgdcf5ff2" class="outline-2">
<h2 id="orgdcf5ff2">어그리게이트(Aggregate)</h2>
<div class="outline-text-2" id="text-orgdcf5ff2">
<p>
어그리게이트는 도큐먼트를 파이프라인을 통해 여러 차례에 걸쳐서 처리할 수 있도록 하는 특수한
기능입니다. 마치 UNIX 유틸리티를 파이프로 묶어서 결과물을 처리하고 이걸 결과로
넘기는 식이 일렬로 처리되는 것과 비슷합니다.
</p>
</div>
<div id="outline-container-orgcb88c10" class="outline-3">
<h3 id="orgcb88c10">기초</h3>
<div class="outline-text-3" id="text-orgcb88c10">
<p>
어그리게이트의 기본 문법은 아래와 같습니다.
</p>
<div class="org-src-container">
<pre class="src src-text">db.collection.aggregate([{SYNTAX}, ...])
</pre>
</div>
<p>
<code>aggregate</code> 의 매개변수가 리스트라는 점에 주의합시다. 리스트 안에 나열되는
식들은 각각 함수나 유틸리티 형태이고, 이 리스트의 순서대로 데이터가 흐르며 처리됩니다.
</p>
</div>
</div>
<div id="outline-container-orgc93d477" class="outline-3">
<h3 id="orgc93d477">예제</h3>
<div class="outline-text-3" id="text-orgc93d477">
<p>
아래의 예제를 기준으로 몇 가지 세부 기능들을 살펴보겠습니다.
</p>
<div class="org-src-container">
<pre class="src src-text">db.user.aggregate([
    {$match:
        {created: {$gte: ISODate("2000-01-01T00:00:00")}}
    },
    {$group:
        {_id: '$address',
         count: {$sum: 1}
        },
    },
])
</pre>
</div>
<p>
두 개의 기능을 이용한 어그리게이트 예제로, user라는 컬렉션에서 2000년 이후로
가입한 사람들만 간추려서 주소가 같은 사용자의 갯수를 센다고 가정한 예제입니다.
</p>

<p>
여기서 제일 처음의 <code>$match</code> 는 <code>find</code> 와 비슷하게 컬렉션에서 도큐먼트를
필터링해서 다음으로 넘깁니다.
</p>

<p>
그 다음의 <code>$group</code> 은 앞서 필터링 된 도큐먼트를 받아서 <code>address</code> 라는 필터를 기준으로 도큐먼트의 합을
계산합니다. <code>$sum</code> 함수는 데이터의 합계를 구하는 함수인데 여기서는 갯수를 세기
위함이므로 1이라는 숫자로 합합니다.
</p>

<p>
바로 이해가 안 될 수도 있지만 순차적인 파이프를 탄다는 것이 이해가 되면
거의 절반은 이해한 셈입니다.
</p>
</div>
</div>
<div id="outline-container-orgb25d71d" class="outline-3">
<h3 id="orgb25d71d">몇 가지 유용한 파이프라인 오퍼레이터</h3>
<div class="outline-text-3" id="text-orgb25d71d">
<ul class="org-ul">
<li><code>$match</code> 필터 혹은 쿼리(find와 비슷)</li>
<li><code>$group</code> 특정한 필드를 기준으로 모으기(grouping)</li>
<li><code>$project</code> 도큐먼트의 모양을 바꿈</li>
<li><code>$lookup</code> 다른 컬렉션의 필드 가져오기(join과 비슷)</li>
<li><code>$sort</code> 정렬</li>
<li><code>$limit</code> 갯수 제한</li>
<li><code>$count</code> 도큐먼트 갯수</li>
</ul>

<p>
사실상 $match와 $group이 가장 많이 쓰이므로 이 둘을 잘 알아두면 유용하게 쓸 수 있습니다.
</p>

<p>
굉장히 많은 기능들 중 몇 가지만 이름으로 정리했기 때문에
<a target="_blank" href="https://docs.mongodb.com/manual/reference/operator/aggregation-pipeline/">🌏 Aggregation
Pipeline Stages</a> 문서를 참고하는 것도 좋을 것 같습니다.
</p>
</div>
</div>
</div>
<div id="outline-container-org39be9d2" class="outline-2">
<h2 id="org39be9d2">백업 및 복원(Dump and Restore)</h2>
<div class="outline-text-2" id="text-org39be9d2">
</div>
<div id="outline-container-orgfee39d5" class="outline-3">
<h3 id="orgfee39d5">Dump</h3>
<div class="outline-text-3" id="text-orgfee39d5">
<div class="org-src-container">
<pre class="src src-bash">mongodump --host host.foo.bar <span style="color: #98be65;">\</span>
          --out /foo/bar/dump/directory <span style="color: #98be65;">\</span>
          --db dbName <span style="color: #98be65;">\</span>
          -c collectionName <span style="color: #98be65;">\</span>
          -q <span style="color: #98be65;">'{key: value}'</span>
</pre>
</div>
<p>
그냥 자주 쓸 만한 옵션을 다 붙여서 나열한 것이고 이 중에 필요한 것만 골라서
사용하면 됩니다.
</p>
</div>
</div>
<div id="outline-container-org50d0515" class="outline-3">
<h3 id="org50d0515">Restore</h3>
<div class="outline-text-3" id="text-org50d0515">
<div class="org-src-container">
<pre class="src src-bash">mongorestore --host host.foo.bar /foo/bar/dump/directory
</pre>
</div>
<p>
덤프 때 데이터베이스 관련 정보도 덤프되므로 복원할 때는 다른 옵션이 필요하지 않습니다.
</p>
</div>
</div>
</div>
<div id="outline-container-org5a62270" class="outline-2">
<h2 id="org5a62270">기타</h2>
<div class="outline-text-2" id="text-org5a62270">
</div>
<div id="outline-container-org85254f2" class="outline-3">
<h3 id="org85254f2">컬렉션 몽땅 비우기(지우기)</h3>
<div class="outline-text-3" id="text-org85254f2">
<div class="org-src-container">
<pre class="src src-javascript">db.collection.remove({})
</pre>
</div>
</div>
</div>
<div id="outline-container-orgbe117f4" class="outline-3">
<h3 id="orgbe117f4">Replica Set 에서 Primary 바꾸기</h3>
<div class="outline-text-3" id="text-orgbe117f4">
<p>
쿠버네티스(Kubernetes) 등등에
레플리카 세트를 구축한 상태에서 모종의 사태(?)로 엉뚱한 녀석이 primary 가 된
경우 priority 를 수정해야 합니다. 아래의 메모는 이 행위를 위해 제가 삽질해서
알아낸 정보를 정리한 것이며 절대적인 해결책인지는 파악하지 못 했다는 점을 참고 바랍니다.
</p>

<p>
우선 mongo cli 도구로 접속해서 설정을 얻어봅시다.
</p>
<div class="org-src-container">
<pre class="src src-text">&gt; cfg = rs.conf()
</pre>
</div>
<p>
여기서 members 의 내용을 잘 살펴봅시다. ip 주소가 적혀있는데 뭐가 primary가
되어야하는지 파악해야 합니다. 파악이 되면 primary를 제외한 나머지의 priority를
낮춰줘야 합니다.
</p>
<div class="org-src-container">
<pre class="src src-text">&gt; cfg.members[1].priority = 0.5
</pre>
</div>
<p>
1은 그냥 예제일 뿐이고 정확한 인덱스를 입력해야 합니다. 0.5라는 수치도 그냥
예제이며 그냥 primary 의 priority 보다 작기만 하면 됩니다.
</p>

<p>
수치를 다 바꿨으면 설정을 업데이트 해야 합니다.
</p>
<div class="org-src-container">
<pre class="src src-text">&gt; rs.reconfig(cfg)
</pre>
</div>
<p>
이러면 딱히 리스타트 하지 않아도 바뀌는 것 같습니다.
</p>

<p>
그래도 간혹 사고가 나서 다시 돌아가는 경우도&#x2026; (응?)
</p>
</div>
</div>
</div>
<div id="footer"><div id="time">2020년 01월 06일 마지막으로 수정됨</div><div id="copyright">Copyright 2019 Heeseung Seo (Seorenn)</div></div></div>
</body>
</html>
