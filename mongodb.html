<!DOCTYPE html>
<html lang="kr">
<head>
<!-- 2019-11-23 Sat 16:40 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>MongoDB - Seorenn Static Pages</title>
<meta name="generator" content="Org mode">
<meta name="author" content="Heeseung Seo (Seorenn)">
<meta name="description" content="몽고디비(MongoDB)의 간단한 소개와 사용법 정리"
>
<link rel="stylesheet" type="text/css" href="/static/style.css"/>
<link rel="shortcut icon" type="image/x-icon" href="favicon.ico"/>
<link rel="canonical" href="https://seorenn.github.io/mongodb.html"/>
<meta name="google-site-verification" content="YqTFZuthbvGIlDE1dhxiTjZ3m-GfyNs_rsHaOlPKpug" />
<meta name="naver-site-verification" content="ebf6a89968fd9f447c1a77d83e2c4aa9bdbb0345"/>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-44534026-1"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-44534026-1');
</script>
</head>
<body>
<div id="content">
<header>
<h1 class="title">MongoDB</h1>
<h2><a href="/">Seorenn Static Pages</a></h2></header><p>
MongoDB 는 이름처럼 Database 시스템입니다. 가장 큰 특징은 도큐먼트 기반
데이터베이스, 즉 고정된 스키마가 없는 동적인 데이터를 관리하는
데이터베이스입니다.
이로 인해 NoSQL DB 의 대명사가 되기도 했습니다.
</p>

<div id="outline-container-org8db06a7" class="outline-2">
<h2 id="org8db06a7">사용법 메모</h2>
<div class="outline-text-2" id="text-org8db06a7">
</div>
<div id="outline-container-org9faa6c9" class="outline-3">
<h3 id="org9faa6c9">연결하기(Connect)</h3>
<div class="outline-text-3" id="text-org9faa6c9">
<div class="org-src-container">
<pre class="src src-bash">mongo --host foo.bar --port <span style="color: #da8548; font-weight: bold;">27017</span>
</pre>
</div>
<p>
참고로 27017은 MongoDB 의 Default Port 입니다. 따라서 이 경우 생략해도 됩니다.
</p>

<p>
이 외에 URI를 이용한 접속도 가능합니다.
</p>
<div class="org-src-container">
<pre class="src src-bash">mongo mongodb://host.foo.bar:27017/dbname
</pre>
</div>
<p>
dbname 은 생략할 수 있습니다.
</p>
</div>
</div>
<div id="outline-container-orgf18a854" class="outline-3">
<h3 id="orgf18a854">데이터베이스 선택(Select Database)</h3>
<div class="outline-text-3" id="text-orgf18a854">
<div class="org-src-container">
<pre class="src src-javascript">use dbname
</pre>
</div>
</div>
</div>
<div id="outline-container-org73de224" class="outline-3">
<h3 id="org73de224">컬렉션 조회(List Collections)</h3>
<div class="outline-text-3" id="text-org73de224">
<div class="org-src-container">
<pre class="src src-javascript">show collections
</pre>
</div>
</div>
</div>
<div id="outline-container-org5f7a046" class="outline-3">
<h3 id="org5f7a046">삽입(Insert)</h3>
<div class="outline-text-3" id="text-org5f7a046">
<div class="org-src-container">
<pre class="src src-javascript">db.collection.insert({key: value, ...})
</pre>
</div>
</div>
</div>
<div id="outline-container-org9e2f3cb" class="outline-3">
<h3 id="org9e2f3cb">조회(Find or Query)</h3>
<div class="outline-text-3" id="text-org9e2f3cb">
<div class="org-src-container">
<pre class="src src-javascript">db.colllection.find({key: value, ...})
</pre>
</div>
<p>
좀 더 고급 검색 쿼리는 아래에 따로 메모합니다.
</p>
</div>
</div>
<div id="outline-container-orgcb4454e" class="outline-3">
<h3 id="orgcb4454e">수정(Update)</h3>
<div class="outline-text-3" id="text-orgcb4454e">
<div class="org-src-container">
<pre class="src src-javascript">db.collection.update({key: value, ...}, {$set: {key: value, ...}})
</pre>
</div>
<p>
첫 매개변수는 어떤 도큐먼트인지 검색하기 위한 조건으로 find 에서 쓰는 쿼리와
동일합니다.
</p>

<p>
두 번째 매개변수는 업데이트 하려는 내요을 적는 곳입니다.
위 예제는 특정 필드의 값을 업데이트(set) 하려는 경우이고,
도큐먼트를 통째로 갈아 엎으려면 그냥 두 번째 매개변수에 도큐먼드를 그냥 넣어버리면 됩니다.
</p>
</div>
</div>
<div id="outline-container-org54e9324" class="outline-3">
<h3 id="org54e9324">삭제(Remove)</h3>
<div class="outline-text-3" id="text-org54e9324">
<div class="org-src-container">
<pre class="src src-javascript">db.collection.remove({key: value, ...})
</pre>
</div>
<p>
당연히 find 에서 쓰던 쿼리를 그대로 쓸 수 있습니다.
</p>
</div>
</div>
</div>
<div id="outline-container-orgb36ca08" class="outline-2">
<h2 id="orgb36ca08">조회법 메모</h2>
<div class="outline-text-2" id="text-orgb36ca08">
</div>
<div id="outline-container-org207f182" class="outline-3">
<h3 id="org207f182">정렬, 위치, 갯수 제한</h3>
<div class="outline-text-3" id="text-org207f182">
<div class="org-src-container">
<pre class="src src-javascript">db.collection.find({key: value, ...})
             .sort({field: -<span style="color: #da8548; font-weight: bold;">1</span>})
             .skip(<span style="color: #da8548; font-weight: bold;">5</span>)
             .limit(<span style="color: #da8548; font-weight: bold;">10</span>)
</pre>
</div>
<p>
정렬 시 -1 값은 역순(Descending) 정렬을 의미합니다. 반대로 1은 순차(Ascending)로 정렬합니다.
</p>
</div>
</div>
<div id="outline-container-orgf64e366" class="outline-3">
<h3 id="orgf64e366">수치 비교</h3>
<div class="outline-text-3" id="text-orgf64e366">
<div class="org-src-container">
<pre class="src src-javascript">db.collection.find({key: {$gt: <span style="color: #da8548; font-weight: bold;">10</span>}})
</pre>
</div>
<p>
<code>gt</code> (Greater Than), <code>lt</code> (Less Than), <code>gte</code> (Greater Than or Equal), <code>lte</code>
(Less Than or Equal)
</p>
</div>
</div>
<div id="outline-container-org956db5c" class="outline-3">
<h3 id="org956db5c">특정 필드 표시하지 않기</h3>
<div class="outline-text-3" id="text-org956db5c">
<div class="org-src-container">
<pre class="src src-javascript">db.collection.find({key: value, ...},
                   {keyToHide: <span style="color: #da8548; font-weight: bold;">0</span>})
</pre>
</div>
<p>
find()의 두 번째 필드는 여러 옵션을 줄 수 있는데 이렇게 특정 필드를 필터링 할 수도 있습니다.
</p>
</div>
</div>
<div id="outline-container-orge2d8b6a" class="outline-3">
<h3 id="orge2d8b6a">특정 필드가 있는 도큐먼트 검색하기</h3>
<div class="outline-text-3" id="text-orge2d8b6a">
<div class="org-src-container">
<pre class="src src-javascript">db.collection.find({key: {$exists: <span style="color: #a9a1e1;">true</span>}})
</pre>
</div>
<p>
물론 <code>false</code> 로 특정 필드가 없는 도큐먼트를 조회하는 것도 가능합니다.
</p>
</div>
</div>
<div id="outline-container-org2e16c21" class="outline-3">
<h3 id="org2e16c21">Not Null???</h3>
<div class="outline-text-3" id="text-org2e16c21">
<div class="org-src-container">
<pre class="src src-javascript">db.collection.find({key: {$ne: <span style="color: #a9a1e1;">null</span>}})
</pre>
</div>
<p>
참고로 <code>ne</code> 는 Not Equal 의 약자입니다.
</p>
</div>
</div>
</div>
<div id="outline-container-orga61a77a" class="outline-2">
<h2 id="orga61a77a">어그리게이트(Aggregate) 예제</h2>
<div class="outline-text-2" id="text-orga61a77a">
</div>
<div id="outline-container-orga24170a" class="outline-3">
<h3 id="orga24170a">여러 컬렉션에서 한번에 쿼리하기</h3>
<div class="outline-text-3" id="text-orga24170a">
<div class="org-src-container">
<pre class="src src-javascript">db.collection.aggregate([{
    $lookup: {
        from: <span style="color: #98be65;">'anotherCollection'</span>,
        localField: <span style="color: #98be65;">'key'</span>,
        foreignField: <span style="color: #98be65;">'anotherKey'</span>,
        as: <span style="color: #98be65;">'anotherKeys'</span>
    }
}])
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org8e244e5" class="outline-2">
<h2 id="org8e244e5">백업 및 복원(Dump and Restore)</h2>
<div class="outline-text-2" id="text-org8e244e5">
</div>
<div id="outline-container-org9770b56" class="outline-3">
<h3 id="org9770b56">Dump</h3>
<div class="outline-text-3" id="text-org9770b56">
<div class="org-src-container">
<pre class="src src-bash">mongodump --host host.foo.bar <span style="color: #98be65;">\</span>
          --out /foo/bar/dump/directory <span style="color: #98be65;">\</span>
          --db dbName <span style="color: #98be65;">\</span>
          -c collectionName <span style="color: #98be65;">\</span>
          -q <span style="color: #98be65;">'{key: value}'</span>
</pre>
</div>
<p>
그냥 자주 쓸 만한 옵션을 다 붙여서 나열한 것이고 이 중에 필요한 것만 골라서
사용하면 됩니다.
</p>
</div>
</div>
<div id="outline-container-orgdc19bee" class="outline-3">
<h3 id="orgdc19bee">Restore</h3>
<div class="outline-text-3" id="text-orgdc19bee">
<div class="org-src-container">
<pre class="src src-bash">mongorestore --host host.foo.bar /foo/bar/dump/directory
</pre>
</div>
<p>
덤프 때 데이터베이스 관련 정보도 덤프되므로 복원할 때는 다른 옵션이 필요하지 않습니다.
</p>
</div>
</div>
</div>
<div id="outline-container-org6e445a8" class="outline-2">
<h2 id="org6e445a8">기타</h2>
<div class="outline-text-2" id="text-org6e445a8">
</div>
<div id="outline-container-org82d36fe" class="outline-3">
<h3 id="org82d36fe">컬렉션 몽땅 비우기(지우기)</h3>
<div class="outline-text-3" id="text-org82d36fe">
<div class="org-src-container">
<pre class="src src-javascript">db.collection.remove({})
</pre>
</div>
</div>
</div>
<div id="outline-container-orgae69706" class="outline-3">
<h3 id="orgae69706">Replica Set 에서 Primary 바꾸기</h3>
<div class="outline-text-3" id="text-orgae69706">
<p>
쿠버네티스(Kubernetes) 등등에
레플리카 세트를 구축한 상태에서 모종의 사태(?)로 엉뚱한 녀석이 primary 가 된
경우 priority 를 수정해야 합니다. 아래의 메모는 이 행위를 위해 제가 삽질해서
알아낸 정보를 정리한 것이며 절대적인 해결책인지는 파악하지 못 했다는 점을 참고 바랍니다.
</p>

<p>
우선 mongo cli 도구로 접속해서 설정을 얻어봅시다.
</p>
<div class="org-src-container">
<pre class="src src-text">&gt; cfg = rs.conf()
</pre>
</div>
<p>
여기서 members 의 내용을 잘 살펴봅시다. ip 주소가 적혀있는데 뭐가 primary가
되어야하는지 파악해야 합니다. 파악이 되면 primary를 제외한 나머지의 priority를
낮춰줘야 합니다.
</p>
<div class="org-src-container">
<pre class="src src-text">&gt; cfg.members[1].priority = 0.5
</pre>
</div>
<p>
1은 그냥 예제일 뿐이고 정확한 인덱스를 입력해야 합니다. 0.5라는 수치도 그냥
예제이며 그냥 primary 의 priority 보다 작기만 하면 됩니다.
</p>

<p>
수치를 다 바꿨으면 설정을 업데이트 해야 합니다.
</p>
<div class="org-src-container">
<pre class="src src-text">&gt; rs.reconfig(cfg)
</pre>
</div>
<p>
이러면 딱히 리스타트 하지 않아도 바뀌는 것 같습니다.
</p>

<p>
그래도 간혹 사고가 나서 다시 돌아가는 경우도&#x2026; (응?)
</p>
</div>
</div>
</div>
<div id="footer"><div id="time">2019년 11월 23일 마지막으로 수정됨</div><div id="copyright">Copyright 2019 Heeseung Seo (Seorenn)</div></div></div>
</body>
</html>
